<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure POD - POD Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #0d6efd;
        }
        .resource-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .resource-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 10px rgba(13, 110, 253, 0.1);
        }
        .resource-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #0d6efd, #6610f2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        .step-completed {
            background: #198754;
        }
        .step-current {
            background: #fd7e14;
        }
        .jira-story-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fff;
        }
        .story-points {
            background: #6610f2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .priority-high { border-left: 4px solid #dc3545; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-low { border-left: 4px solid #28a745; }
        .launch-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
        }
        .btn-launch {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .btn-launch:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: #28a745;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-cubes me-2"></i>POD Management</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard.html">Dashboard</a>
                <a class="nav-link" href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Progress Indicator -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">POD Setup Progress</h5>
                        <div class="progress-step">
                            <div class="step-number step-completed">1</div>
                            <span>POD Created</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-number step-current">2</div>
                            <span>Configure POD & Create JIRA Stories</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">3</div>
                            <span>Launch POD</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- POD Information -->
                <div class="config-section">
                    <h4><i class="fas fa-info-circle me-2"></i>POD Information</h4>
                    <div id="podInfo">
                        <p><strong>POD ID:</strong> <span id="podIdDisplay"></span></p>
                        <p><strong>POD Name:</strong> <span id="podNameDisplay"></span></p>
                        <p><strong>Business Line:</strong> <span id="businessLineDisplay"></span></p>
                        <p><strong>Country:</strong> <span id="countryDisplay"></span></p>
                        <p><strong>Duration:</strong> <span id="durationDisplay"></span></p>
                    </div>
                </div>

                <!-- Configuration Form -->
                <div class="config-section">
                    <h4><i class="fas fa-cogs me-2"></i>POD Configuration</h4>
                    <form id="configForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Team Size</label>
                                <input type="number" class="form-control" id="teamSize" min="1" max="20" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sprint Duration (weeks)</label>
                                <select class="form-select" id="sprintDuration" required>
                                    <option value="">Select Duration</option>
                                    <option value="1">1 week</option>
                                    <option value="2">2 weeks</option>
                                    <option value="3">3 weeks</option>
                                    <option value="4">4 weeks</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Deliverables</label>
                            <textarea class="form-control" id="deliverables" rows="3" 
                                placeholder="List the key deliverables for this POD..."></textarea>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Success Criteria</label>
                            <textarea class="form-control" id="successCriteria" rows="3" 
                                placeholder="Define what success looks like for this POD..."></textarea>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">BA Handover Date</label>
                                <input type="date" class="form-control" id="baHandover">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Reverse Walkthrough Date</label>
                                <input type="date" class="form-control" id="reverseWalkthrough">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Review Day</label>
                                <select class="form-select" id="reviewDay">
                                    <option value="">Select Day</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Resource Allocation Section -->
                <div class="config-section">
                    <h4><i class="fas fa-users me-2"></i>Resource Allocation</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Available Team Members</h6>
                            <div id="availableResources">
                                <!-- Available resources will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Assigned to POD <span id="assignedCount" class="badge bg-primary">0</span></h6>
                            <div id="assignedResources">
                                <!-- Assigned resources will be shown here -->
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Required Skills</h6>
                        <div id="skillsContainer">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skillFullStack">
                                        <label class="form-check-label" for="skillFullStack">Full Stack Development</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skillFrontend">
                                        <label class="form-check-label" for="skillFrontend">Frontend Development</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skillBackend">
                                        <label class="form-check-label" for="skillBackend">Backend Development</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skillQA">
                                        <label class="form-check-label" for="skillQA">QA Testing</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skillDevOps">
                                        <label class="form-check-label" for="skillDevOps">DevOps</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skillBA">
                                        <label class="form-check-label" for="skillBA">Business Analysis</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JIRA Story Creation Section -->
                <div class="config-section">
                    <h4><i class="fab fa-jira me-2"></i>JIRA Story Creation</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="mb-0">Create JIRA stories for this POD based on scope and deliverables</p>
                        <button type="button" class="btn btn-outline-primary" onclick="showCreateStoryModal()">
                            <i class="fas fa-plus me-1"></i>Create Story
                        </button>
                    </div>
                    
                    <div id="jiraStoriesContainer">
                        <!-- JIRA stories will be displayed here -->
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary me-2" onclick="generateDemoStories()">
                            <i class="fas fa-magic me-1"></i>Generate Demo Stories
                        </button>
                        <button type="button" class="btn btn-info" onclick="loadStoryTemplates()">
                            <i class="fas fa-template me-1"></i>Use Template
                        </button>
                    </div>
                </div>

                <!-- Save Configuration -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary btn-lg me-3" onclick="saveConfiguration()">
                        <i class="fas fa-save me-2"></i>Save Configuration
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="goBack()">
                        <i class="fas fa-arrow-left me-2"></i>Go Back
                    </button>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Configuration Summary -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Configuration Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="configSummary">
                            <p><strong>Team Size:</strong> <span id="summaryTeamSize">Not set</span></p>
                            <p><strong>Sprint Duration:</strong> <span id="summarySprint">Not set</span></p>
                            <p><strong>Assigned Resources:</strong> <span id="summaryResources">0</span></p>
                            <p><strong>JIRA Stories:</strong> <span id="summaryStories">0</span></p>
                            <p><strong>Required Skills:</strong> <span id="summarySkills">None</span></p>
                        </div>
                        
                        <div class="mt-3 pt-3 border-top">
                            <h6>Configuration Status</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar" id="configProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">Complete all sections to launch POD</small>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-info btn-sm mb-2 w-100" onclick="autoAssignResources()">
                            <i class="fas fa-users-cog me-1"></i>Auto-Assign Resources
                        </button>
                        <button class="btn btn-outline-warning btn-sm mb-2 w-100" onclick="importFromJira()">
                            <i class="fab fa-jira me-1"></i>Import from JIRA
                        </button>
                        <button class="btn btn-outline-success btn-sm w-100" onclick="previewPod()">
                            <i class="fas fa-eye me-1"></i>Preview POD
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Launch POD Section (shown when configuration is complete) -->
        <div id="launchSection" class="launch-section" style="display: none;">
            <h2><i class="fas fa-rocket me-3"></i>Ready to Launch POD!</h2>
            <p class="lead mb-4">Your POD configuration is complete. Launch to activate the team and begin sprint execution.</p>
            
            <div class="row text-center mb-4">
                <div class="col-md-3">
                    <h4 id="launchTeamSize">5</h4>
                    <small>Team Members</small>
                </div>
                <div class="col-md-3">
                    <h4 id="launchStoriesCount">3</h4>
                    <small>JIRA Stories</small>
                </div>
                <div class="col-md-3">
                    <h4 id="launchSprintWeeks">2</h4>
                    <small>Sprint Weeks</small>
                </div>
                <div class="col-md-3">
                    <h4 id="launchEstimatedHours">120</h4>
                    <small>Est. Hours</small>
                </div>
            </div>

            <button type="button" class="btn btn-launch btn-lg" onclick="launchPod()">
                <i class="fas fa-rocket me-2"></i>Launch POD
            </button>
        </div>
    </div>

    <!-- Create JIRA Story Modal -->
    <div class="modal fade" id="createStoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fab fa-jira me-2"></i>Create JIRA Story</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="storyForm">
                        <div class="mb-3">
                            <label class="form-label">Story Title</label>
                            <input type="text" class="form-control" id="storyTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Story Description</label>
                            <textarea class="form-control" id="storyDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Acceptance Criteria</label>
                            <textarea class="form-control" id="acceptanceCriteria" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Business Benefit</label>
                            <textarea class="form-control" id="businessBenefit" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Story Points</label>
                                <select class="form-select" id="storyPoints">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5" selected>5</option>
                                    <option value="8">8</option>
                                    <option value="13">13</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="storyPriority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Assignee</label>
                                <select class="form-select" id="storyAssignee">
                                    <option value="">Unassigned</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createJiraStory()">Create Story</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPod = null;
        let assignedResources = [];
        let jiraStories = [];
        let configProgress = 0;

        // Available team members for demo
        const availableTeamMembers = [
            { id: 1, name: 'Asif Mohammed', role: 'Technical Lead', skills: ['Full Stack', 'Backend', 'DevOps'], avatar: 'AM' },
            { id: 2, name: 'Kanya', role: 'Senior Developer', skills: ['Frontend', 'Full Stack'], avatar: 'K' },
            { id: 3, name: 'Srini', role: 'Full Stack Developer', skills: ['Full Stack', 'QA'], avatar: 'S' },
            { id: 4, name: 'Maria Garcia', role: 'QA Engineer', skills: ['QA', 'Testing'], avatar: 'MG' },
            { id: 5, name: 'Carlos Silva', role: 'DevOps Engineer', skills: ['DevOps', 'Backend'], avatar: 'CS' },
            { id: 6, name: 'Ana Rodriguez', role: 'Business Analyst', skills: ['Business Analysis'], avatar: 'AR' },
            { id: 7, name: 'Pedro Martinez', role: 'Frontend Developer', skills: ['Frontend', 'UI/UX'], avatar: 'PM' },
            { id: 8, name: 'Luis Fernando', role: 'Backend Developer', skills: ['Backend', 'Database'], avatar: 'LF' }
        ];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPodData();
            renderAvailableResources();
            updateConfigSummary();
            
            // Add event listeners for real-time updates
            document.getElementById('teamSize').addEventListener('input', updateConfigSummary);
            document.getElementById('sprintDuration').addEventListener('change', updateConfigSummary);
        });

        // Load POD data from URL parameters or localStorage
        function loadPodData() {
            const urlParams = new URLSearchParams(window.location.search);
            const podId = urlParams.get('podId');
            
            console.log('🔍 Loading POD data for ID:', podId);
            console.log('🔍 Current URL:', window.location.href);
            
            if (!podId) {
                console.error('❌ No podId found in URL parameters');
                showToast('No POD ID found in URL. Please create a POD first.', 'error');
                setTimeout(() => {
                    window.location.href = '/create-pod.html';
                }, 3000);
                return;
            }
            
            // Try to get from API first
            console.log('📡 Fetching POD data from API...');
            fetch(`/api/pods/${podId}`)
                .then(response => {
                    console.log('📡 API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ POD data loaded from API:', data);
                    currentPod = data;
                    displayPodInfo();
                    prePopulateFromJira();
                })
                .catch(error => {
                    console.log('⚠️ API call failed, using mock data:', error);
                    // Use mock data for demo
                    currentPod = {
                        pod_id: podId,
                        pod_name: `Demo POD for ${podId}`,
                        business_line: podId.split('-')[0] || 'AML',
                        country: podId.split('-')[1] || 'MEX',
                        start_date: '2025-07-01',
                        end_date: '2025-09-30',
                        estimated_hours: 120,
                        import_source: 'jira' // Force JIRA import for demo
                    };
                    
                    console.log('📝 Using mock POD data:', currentPod);
                    displayPodInfo();
                    prePopulateFromJira();
                });
        }

        // Display POD information
        function displayPodInfo() {
            if (!currentPod) return;
            
            document.getElementById('podIdDisplay').textContent = currentPod.pod_id || currentPod.podId;
            document.getElementById('podNameDisplay').textContent = currentPod.pod_name || currentPod.podName;
            document.getElementById('businessLineDisplay').textContent = currentPod.business_line || currentPod.businessLine;
            document.getElementById('countryDisplay').textContent = currentPod.country;
            
            const startDate = new Date(currentPod.start_date || currentPod.startDate);
            const endDate = new Date(currentPod.end_date || currentPod.endDate);
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 7));
            document.getElementById('durationDisplay').textContent = `${duration} weeks`;
        }

        // Pre-populate fields if POD was created from JIRA import
        function prePopulateFromJira() {
            console.log('🔄 Starting pre-population process...');
            
            // First check localStorage for import data
            const importDataStr = localStorage.getItem('podImportData');
            let importData = null;
            
            console.log('📦 localStorage podImportData:', importDataStr);
            
            if (importDataStr) {
                const storedData = JSON.parse(importDataStr);
                if (storedData.podId === currentPod.pod_id || storedData.podId === currentPod.podId) {
                    importData = storedData;
                    console.log('📥 Found import data in localStorage:', importData);
                }
            }
            
            // Also check if POD has import metadata
            if (currentPod && currentPod.import_source === 'jira') {
                const metadata = currentPod.import_metadata ? JSON.parse(currentPod.import_metadata) : null;
                if (metadata) {
                    importData = { importSource: 'jira', importData: metadata };
                    console.log('📥 Found import data in POD metadata:', importData);
                }
            }
            
            // FOR DEMO: Force JIRA import if none found
            if (!importData && currentPod) {
                console.log('🎭 No import data found, creating demo JIRA import...');
                importData = {
                    importSource: 'jira',
                    importData: {
                        key: 'AML-1001',
                        summary: 'Implement customer screening for Mexico AML compliance',
                        description: 'Develop automated customer screening system to meet Mexican AML regulatory requirements',
                        businessLine: 'AML',
                        country: 'Mexico',
                        scope: 'Build comprehensive customer screening system with real-time monitoring capabilities',
                        deliverables: [
                            'Customer screening API',
                            'Risk assessment engine', 
                            'Compliance reporting dashboard',
                            'Integration with existing systems'
                        ],
                        acceptanceCriteria: 'System must screen 100% of new customers within 30 seconds and flag high-risk profiles',
                        timeEstimate: '120h',
                        storyPoints: 8,
                        priority: 'High'
                    }
                };
                console.log('🎭 Created demo import data:', importData);
            }
            
            if (importData && importData.importSource === 'jira' && importData.importData) {
                const jiraData = importData.importData;
                console.log('🔄 Pre-populating from JIRA data:', jiraData);
                
                // Pre-fill deliverables from JIRA
                if (jiraData.deliverables && Array.isArray(jiraData.deliverables)) {
                    const deliverableText = '• ' + jiraData.deliverables.join('\n• ');
                    document.getElementById('deliverables').value = deliverableText;
                    console.log('✅ Set deliverables:', deliverableText);
                } else if (jiraData.scope) {
                    const deliverableText = `• ${jiraData.scope}\n• System implementation\n• Testing and validation`;
                    document.getElementById('deliverables').value = deliverableText;
                    console.log('✅ Set deliverables from scope:', deliverableText);
                }
                
                // Pre-fill success criteria from JIRA acceptance criteria
                if (jiraData.acceptanceCriteria) {
                    document.getElementById('successCriteria').value = jiraData.acceptanceCriteria;
                    console.log('✅ Set success criteria:', jiraData.acceptanceCriteria);
                } else {
                    const criteria = `System must meet all ${currentPod.business_line} requirements for ${currentPod.country} operations`;
                    document.getElementById('successCriteria').value = criteria;
                    console.log('✅ Set default success criteria:', criteria);
                }
                
                // Set team size based on story points or default
                const estimatedTeamSize = Math.min(Math.max(Math.ceil((jiraData.storyPoints || 8) / 3), 3), 8);
                document.getElementById('teamSize').value = estimatedTeamSize;
                console.log('✅ Set team size:', estimatedTeamSize);
                
                // Set sprint duration based on timeEstimate
                if (jiraData.timeEstimate) {
                    const hours = parseInt(jiraData.timeEstimate.replace('h', ''));
                    const weeks = Math.ceil(hours / (estimatedTeamSize * 40)); // 40 hours per person per week
                    const sprintWeeks = Math.min(Math.max(weeks, 1), 4);
                    document.getElementById('sprintDuration').value = sprintWeeks;
                    console.log('✅ Set sprint duration:', sprintWeeks, 'weeks');
                } else {
                    document.getElementById('sprintDuration').value = '2'; // Default 2 weeks
                    console.log('✅ Set default sprint duration: 2 weeks');
                }
                
                // Auto-create initial JIRA story from import data
                setTimeout(() => {
                    createInitialJiraStory(jiraData);
                }, 1000);
                
                // Show success message
                showToast(`✅ Pre-populated from JIRA issue ${jiraData.key || 'data'}`, 'success');
                
                // Update summary
                setTimeout(() => {
                    updateConfigSummary();
                }, 500);
                
                // Clean up localStorage
                localStorage.removeItem('podImportData');
            } else if (importData && importData.importSource === 'ccb' && importData.importData) {
                const ccbData = importData.importData;
                console.log('🔄 Pre-populating from CCB data:', ccbData);
                
                // Pre-fill from CCB data
                if (ccbData.deliverables && Array.isArray(ccbData.deliverables)) {
                    const deliverableText = '• ' + ccbData.deliverables.join('\n• ');
                    document.getElementById('deliverables').value = deliverableText;
                } else if (ccbData.scope) {
                    document.getElementById('deliverables').value = `• ${ccbData.scope}\n• Implementation according to CCB requirements\n• Testing and validation`;
                }
                
                document.getElementById('successCriteria').value = `Implementation meets all CCB requirements for ${ccbData.title}`;
                
                // Set team size based on priority
                const teamSize = ccbData.priority === 'Critical' ? 5 : ccbData.priority === 'High' ? 4 : 3;
                document.getElementById('teamSize').value = teamSize;
                document.getElementById('sprintDuration').value = '2';
                
                showToast(`✅ Pre-populated from CCB item ${ccbData.ccbId}`, 'success');
                setTimeout(() => {
                    updateConfigSummary();
                }, 500);
                localStorage.removeItem('podImportData');
            } else {
                console.log('ℹ️ No import data to pre-populate');
            }
        }

        // Create initial JIRA story from import data
        function createInitialJiraStory(importData) {
            const story = {
                id: Date.now(),
                title: importData.summary || `Implement ${currentPod.pod_name}`,
                description: importData.description || importData.scope || '',
                acceptanceCriteria: importData.acceptanceCriteria || '',
                businessBenefit: `Implementation of ${currentPod.business_line} requirements for ${currentPod.country}`,
                storyPoints: 8,
                priority: 'high',
                assignee: 'Asif Mohammed',
                status: 'To Do',
                jiraId: `${currentPod.business_line}-${Date.now().toString().slice(-4)}`
            };
            
            jiraStories.push(story);
            renderJiraStories();
            updateConfigSummary();
            
            // Show success message
            showToast('Initial JIRA story created from import data', 'success');
        }

        // Render available resources
        function renderAvailableResources() {
            const container = document.getElementById('availableResources');
            container.innerHTML = '';
            
            availableTeamMembers.forEach(member => {
                if (!assignedResources.find(r => r.id === member.id)) {
                    const resourceCard = createResourceCard(member, false);
                    container.appendChild(resourceCard);
                }
            });
        }

        // Render assigned resources
        function renderAssignedResources() {
            const container = document.getElementById('assignedResources');
            container.innerHTML = '';
            
            assignedResources.forEach(member => {
                const resourceCard = createResourceCard(member, true);
                container.appendChild(resourceCard);
            });
            
            document.getElementById('assignedCount').textContent = assignedResources.length;
        }

        // Create resource card
        function createResourceCard(member, isAssigned) {
            const card = document.createElement('div');
            card.className = 'resource-card';
            card.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="resource-avatar me-3">${member.avatar}</div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${member.name}</h6>
                        <small class="text-muted">${member.role}</small>
                        <div class="mt-1">
                            ${member.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm ${isAssigned ? 'btn-outline-danger' : 'btn-outline-primary'}" 
                                onclick="${isAssigned ? 'unassignResource' : 'assignResource'}(${member.id})">
                            <i class="fas ${isAssigned ? 'fa-minus' : 'fa-plus'}"></i>
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        // Assign resource to POD
        function assignResource(memberId) {
            const member = availableTeamMembers.find(m => m.id === memberId);
            if (member && !assignedResources.find(r => r.id === memberId)) {
                assignedResources.push(member);
                renderAvailableResources();
                renderAssignedResources();
                updateConfigSummary();
                showToast(`${member.name} assigned to POD`, 'success');
            }
        }

        // Unassign resource from POD
        function unassignResource(memberId) {
            const member = assignedResources.find(m => m.id === memberId);
            if (member) {
                assignedResources = assignedResources.filter(r => r.id !== memberId);
                renderAvailableResources();
                renderAssignedResources();
                updateConfigSummary();
                showToast(`${member.name} removed from POD`, 'warning');
            }
        }

        // Auto-assign resources based on required skills
        function autoAssignResources() {
            const teamSize = parseInt(document.getElementById('teamSize').value) || 0;
            if (teamSize === 0) {
                showToast('Please set team size first', 'warning');
                return;
            }

            // Get checked skills
            const requiredSkills = [];
            document.querySelectorAll('#skillsContainer input[type="checkbox"]:checked').forEach(checkbox => {
                requiredSkills.push(checkbox.nextElementSibling.textContent);
            });

            // Clear current assignments
            assignedResources = [];

            // Auto-assign based on skills and availability
            let assigned = 0;
            for (let member of availableTeamMembers) {
                if (assigned >= teamSize) break;
                
                if (requiredSkills.length === 0 || member.skills.some(skill => 
                    requiredSkills.some(req => skill.includes(req.split(' ')[0])))) {
                    assignedResources.push(member);
                    assigned++;
                }
            }

            // Fill remaining slots if needed
            while (assigned < teamSize && assigned < availableTeamMembers.length) {
                const remaining = availableTeamMembers.filter(m => !assignedResources.find(a => a.id === m.id));
                if (remaining.length > 0) {
                    assignedResources.push(remaining[0]);
                    assigned++;
                } else {
                    break;
                }
            }

            renderAvailableResources();
            renderAssignedResources();
            updateConfigSummary();
            showToast(`Auto-assigned ${assigned} team members`, 'success');
        }

        // Show create story modal
        function showCreateStoryModal() {
            // Populate assignee dropdown
            const assigneeSelect = document.getElementById('storyAssignee');
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
            assignedResources.forEach(member => {
                assigneeSelect.innerHTML += `<option value="${member.name}">${member.name}</option>`;
            });

            const modal = new bootstrap.Modal(document.getElementById('createStoryModal'));
            modal.show();
        }

        // Create JIRA story
        function createJiraStory() {
            const title = document.getElementById('storyTitle').value;
            if (!title) {
                showToast('Story title is required', 'error');
                return;
            }

            const story = {
                id: Date.now(),
                title: title,
                description: document.getElementById('storyDescription').value,
                acceptanceCriteria: document.getElementById('acceptanceCriteria').value,
                businessBenefit: document.getElementById('businessBenefit').value,
                storyPoints: parseInt(document.getElementById('storyPoints').value),
                priority: document.getElementById('storyPriority').value,
                assignee: document.getElementById('storyAssignee').value,
                status: 'To Do',
                jiraId: `${currentPod.business_line || 'POD'}-${Date.now().toString().slice(-4)}`
            };

            jiraStories.push(story);
            renderJiraStories();
            updateConfigSummary();

            // Clear form and close modal
            document.getElementById('storyForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('createStoryModal')).hide();

            showToast('JIRA story created successfully', 'success');
        }

        // Generate demo stories
        function generateDemoStories() {
            const demoStories = [
                {
                    id: Date.now() + 1,
                    title: `Setup development environment for ${currentPod.pod_name || 'POD'}`,
                    description: 'Configure development environment, version control, and CI/CD pipeline',
                    acceptanceCriteria: 'Given that the team is ready to start development, when the environment is set up, then all team members can access the development tools',
                    businessBenefit: 'Enables efficient development workflow and code quality',
                    storyPoints: 3,
                    priority: 'high',
                    assignee: assignedResources[0]?.name || '',
                    status: 'To Do',
                    jiraId: `${currentPod.business_line || 'POD'}-${(Date.now() + 1).toString().slice(-4)}`
                },
                {
                    id: Date.now() + 2,
                    title: `Implement core business logic for ${currentPod.business_line || 'system'}`,
                    description: 'Develop the main business logic and core functionality according to requirements',
                    acceptanceCriteria: 'Given the business requirements, when the core logic is implemented, then the system performs the primary business functions correctly',
                    businessBenefit: 'Delivers the primary value proposition of the system',
                    storyPoints: 8,
                    priority: 'high',
                    assignee: assignedResources[1]?.name || '',
                    status: 'To Do',
                    jiraId: `${currentPod.business_line || 'POD'}-${(Date.now() + 2).toString().slice(-4)}`
                },
                {
                    id: Date.now() + 3,
                    title: 'Comprehensive testing and quality assurance',
                    description: 'Perform unit testing, integration testing, and user acceptance testing',
                    acceptanceCriteria: 'Given the implemented features, when testing is complete, then all tests pass and quality metrics are met',
                    businessBenefit: 'Ensures system reliability and user satisfaction',
                    storyPoints: 5,
                    priority: 'medium',
                    assignee: assignedResources[2]?.name || '',
                    status: 'To Do',
                    jiraId: `${currentPod.business_line || 'POD'}-${(Date.now() + 3).toString().slice(-4)}`
                }
            ];

            jiraStories.push(...demoStories);
            renderJiraStories();
            updateConfigSummary();
            showToast('Demo stories generated successfully', 'success');
        }

        // Render JIRA stories
        function renderJiraStories() {
            const container = document.getElementById('jiraStoriesContainer');
            container.innerHTML = '';

            if (jiraStories.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No JIRA stories created yet. Click "Create Story" to add one.</p>';
                return;
            }

            jiraStories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = `jira-story-card priority-${story.priority}`;
                storyCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">${story.title}</h6>
                            <small class="text-primary">${story.jiraId}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="story-points me-2">${story.storyPoints}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeStory(${story.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="small mb-2">${story.description}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-${story.priority === 'high' ? 'danger' : story.priority === 'medium' ? 'warning' : 'success'}">${story.priority.toUpperCase()}</span>
                        <small class="text-muted">Assigned to: ${story.assignee || 'Unassigned'}</small>
                    </div>
                `;
                container.appendChild(storyCard);
            });
        }

        // Remove story
        function removeStory(storyId) {
            jiraStories = jiraStories.filter(s => s.id !== storyId);
            renderJiraStories();
            updateConfigSummary();
            showToast('Story removed', 'warning');
        }

        // Update configuration summary
        function updateConfigSummary() {
            const teamSize = document.getElementById('teamSize').value || 'Not set';
            const sprintDuration = document.getElementById('sprintDuration').value ? 
                document.getElementById('sprintDuration').value + ' weeks' : 'Not set';
            
            document.getElementById('summaryTeamSize').textContent = teamSize;
            document.getElementById('summarySprint').textContent = sprintDuration;
            document.getElementById('summaryResources').textContent = assignedResources.length;
            document.getElementById('summaryStories').textContent = jiraStories.length;

            // Update skills summary
            const checkedSkills = [];
            document.querySelectorAll('#skillsContainer input[type="checkbox"]:checked').forEach(checkbox => {
                checkedSkills.push(checkbox.nextElementSibling.textContent);
            });
            document.getElementById('summarySkills').textContent = checkedSkills.length > 0 ? 
                checkedSkills.join(', ') : 'None';

            // Calculate progress
            let progress = 0;
            if (document.getElementById('teamSize').value) progress += 20;
            if (document.getElementById('sprintDuration').value) progress += 20;
            if (assignedResources.length > 0) progress += 30;
            if (jiraStories.length > 0) progress += 20;
            if (document.getElementById('deliverables').value && document.getElementById('successCriteria').value) progress += 10;

            document.getElementById('configProgress').style.width = progress + '%';
            document.getElementById('configProgress').className = `progress-bar ${progress < 50 ? 'bg-danger' : progress < 80 ? 'bg-warning' : 'bg-success'}`;

            // Show launch section if configuration is complete
            if (progress >= 90) {
                document.getElementById('launchSection').style.display = 'block';
                updateLaunchSummary();
            } else {
                document.getElementById('launchSection').style.display = 'none';
            }
        }

        // Update launch summary
        function updateLaunchSummary() {
            document.getElementById('launchTeamSize').textContent = assignedResources.length;
            document.getElementById('launchStoriesCount').textContent = jiraStories.length;
            document.getElementById('launchSprintWeeks').textContent = document.getElementById('sprintDuration').value || '0';
            
            const totalStoryPoints = jiraStories.reduce((sum, story) => sum + story.storyPoints, 0);
            const estimatedHours = totalStoryPoints * 8; // 8 hours per story point
            document.getElementById('launchEstimatedHours').textContent = estimatedHours;
        }

        // Save configuration
        function saveConfiguration() {
            const config = {
                podId: currentPod.pod_id || currentPod.podId,
                teamSize: parseInt(document.getElementById('teamSize').value),
                deliverables: document.getElementById('deliverables').value,
                successCriteria: document.getElementById('successCriteria').value,
                sprintDuration: parseInt(document.getElementById('sprintDuration').value),
                baHandover: document.getElementById('baHandover').value,
                reverseWalkthrough: document.getElementById('reverseWalkthrough').value,
                reviewDay: document.getElementById('reviewDay').value,
                skills: getSelectedSkills(),
                resources: assignedResources,
                jiraStories: jiraStories
            };

            fetch('/api/pods/configure', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Configuration saved successfully', 'success');
                    updateConfigSummary();
                } else {
                    showToast('Error saving configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Configuration saved locally (demo mode)', 'info');
                updateConfigSummary();
            });
        }

        // Get selected skills
        function getSelectedSkills() {
            const skills = [];
            document.querySelectorAll('#skillsContainer input[type="checkbox"]:checked').forEach(checkbox => {
                skills.push(checkbox.nextElementSibling.textContent);
            });
            return skills;
        }

        // Launch POD
        function launchPod() {
            if (!currentPod) {
                showToast('POD data not found', 'error');
                return;
            }

            const confirmLaunch = confirm('Are you sure you want to launch this POD? This will activate the team and begin sprint execution.');
            if (!confirmLaunch) return;

            const launchData = {
                pod_id: currentPod.pod_id || currentPod.podId,
                team_members: assignedResources,
                jira_stories: jiraStories
            };

            console.log('🚀 Launching POD with data:', launchData);

            fetch('/api/pods/launch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(launchData)
            })
            .then(response => {
                console.log('🚀 Launch response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Launch API returned ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('🚀 Launch response data:', data);
                if (data.success) {
                    showToast('POD launched successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 2000);
                } else {
                    showToast('Error launching POD: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('❌ Launch error:', error);
                // For demo purposes, simulate successful launch
                showToast('POD launched successfully! (demo mode)', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 2000);
            });
        }

        // Import from JIRA
        function importFromJira() {
            showToast('JIRA import feature - searching for related stories...', 'info');
            
            // Simulate JIRA import
            setTimeout(() => {
                const jiraImportData = {
                    title: `${currentPod.business_line} Enhancement for ${currentPod.country}`,
                    description: 'Enhancement based on regulatory requirements and business needs',
                    acceptanceCriteria: 'System meets all compliance requirements and business objectives',
                    businessBenefit: 'Improved compliance and operational efficiency',
                    storyPoints: 8,
                    priority: 'high'
                };

                // Pre-fill form fields
                document.getElementById('deliverables').value = `${jiraImportData.title} deliverables:\n- Core system implementation\n- Compliance reporting\n- User training materials`;
                document.getElementById('successCriteria').value = jiraImportData.acceptanceCriteria;

                showToast('JIRA data imported successfully', 'success');
                updateConfigSummary();
            }, 1500);
        }

        // Preview POD
        function previewPod() {
            const config = {
                pod: currentPod,
                teamSize: document.getElementById('teamSize').value,
                assignedResources: assignedResources,
                jiraStories: jiraStories,
                deliverables: document.getElementById('deliverables').value,
                successCriteria: document.getElementById('successCriteria').value
            };

            localStorage.setItem('podPreview', JSON.stringify(config));
            window.open('/pod-summary.html?preview=true', '_blank');
        }

        // Load story templates
        function loadStoryTemplates() {
            fetch('/api/jira/templates')
                .then(response => response.json())
                .then(data => {
                    showToast('Story templates loaded - feature coming soon', 'info');
                })
                .catch(error => {
                    showToast('Story templates feature - coming soon', 'info');
                });
        }

        // Go back
        function goBack() {
            window.history.back();
        }

        // Logout
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'primary'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Create toast container
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        // Initialize demo data if needed
        function initializeDemoData() {
            // Auto-assign some team members for demo
            if (assignedResources.length === 0 && currentPod) {
                assignedResources.push(availableTeamMembers[0]); // Asif
                assignedResources.push(availableTeamMembers[1]); // Kanya
                assignedResources.push(availableTeamMembers[2]); // Srini
                
                renderAvailableResources();
                renderAssignedResources();
                
                // Set some default values
                document.getElementById('teamSize').value = '3';
                document.getElementById('sprintDuration').value = '2';
                
                updateConfigSummary();
            }
        }

        // Initialize demo data after page load
        setTimeout(initializeDemoData, 2000);
    </script>
</body>
</html>