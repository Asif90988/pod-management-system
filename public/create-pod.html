<!DOCTYPE html>
<html>
<head>
    <title>Create POD - POD Management System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            color: #6c757d;
        }

        /* Data Source Selection */
        .data-source-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .data-source-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .source-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .source-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .source-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
        }

        .source-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .source-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .source-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .source-desc {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* JIRA Import Section */
        .jira-import {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .jira-search {
            margin-bottom: 20px;
        }

        .jira-search input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .jira-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .jira-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .jira-item:hover {
            background: #f8f9fa;
        }

        .jira-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .jira-key {
            font-weight: bold;
            color: #2196f3;
            font-family: monospace;
        }

        .jira-summary {
            margin-top: 5px;
            color: #2c3e50;
        }

        .jira-details {
            margin-top: 5px;
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Excel Upload Section */
        .excel-upload {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            margin-bottom: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #4caf50;
            background: #f0fff4;
        }

        .upload-area.dragover {
            border-color: #4caf50;
            background: #e8f5e8;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group { 
            margin: 15px 0; 
        }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #2c3e50;
        }

        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 8px;
            cursor: pointer; 
            margin: 10px 5px;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        .ccb-info { 
            background: linear-gradient(135deg, #e9f7ff, #f0f8ff);
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px;
            border: 2px solid #2196f3;
        }

        .pod-id { 
            font-family: monospace; 
            font-size: 18px; 
            color: #2196f3; 
            font-weight: bold;
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .success { 
            color: green; 
            font-weight: bold; 
        }

        .error { 
            color: red; 
            font-weight: bold; 
        }

        .loading { 
            color: #667eea; 
            font-style: italic; 
        }

        .imported-data {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .imported-label {
            font-size: 0.9em;
            color: #155724;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .import-preview {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .preview-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .source-options {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Create POD</h1>
            <p>Choose your data source or create manually</p>
        </div>

        <!-- Data Source Selection -->
        <div class="data-source-section">
            <div class="data-source-title">üìã Choose Data Source</div>
            <div class="source-options">
                <div class="source-option selected" data-source="manual">
                    <div class="source-icon">‚úèÔ∏è</div>
                    <div class="source-title">Manual Entry</div>
                    <div class="source-desc">Create from scratch</div>
                </div>
                <div class="source-option" data-source="jira">
                    <div class="source-icon">üîó</div>
                    <div class="source-title">Import from JIRA</div>
                    <div class="source-desc">Use existing JIRA epic/story</div>
                </div>
                <div class="source-option" data-source="excel">
                    <div class="source-icon">üìä</div>
                    <div class="source-title">CCB Excel Import</div>
                    <div class="source-desc">Upload CCB spreadsheet</div>
                </div>
                <div class="source-option" data-source="workorder">
                    <div class="source-icon">üìÑ</div>
                    <div class="source-title">Work Order</div>
                    <div class="source-desc">Coming soon...</div>
                </div>
            </div>

            <!-- JIRA Import Section -->
            <div id="jiraImport" class="jira-import">
                <h3>üîç Search JIRA Issues</h3>
                <div class="jira-search">
                    <input type="text" id="jiraSearchInput" placeholder="Search by project key, summary, or ID (e.g., AML-MEX, KYC-PER)...">
                </div>
                <div id="jiraResults" class="jira-results">
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        Enter search terms to find JIRA issues
                    </div>
                </div>
                <div id="importPreview" class="import-preview" style="display: none;">
                    <div class="preview-title">üìã Preview Imported Data:</div>
                    <div id="previewContent"></div>
                </div>
            </div>

            <!-- Excel Upload Section -->
            <div id="excelUpload" class="excel-upload">
                <h3>üìä Upload CCB Excel File</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div><strong>Drop your CCB Excel file here</strong></div>
                    <div>or click to browse</div>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                </div>
                <div id="excelPreview" style="display: none;"></div>
            </div>
        </div>

        <div id="ccbInfo" class="ccb-info">
            <h3>üìã CCB Item Details</h3>
            <div id="ccbDetails">Loading CCB information...</div>
        </div>
        
        <form id="podForm">
            <h3>üÜî POD Information</h3>
            
            <div class="form-group">
                <label>Auto-Generated POD ID:</label>
                <div id="podId" class="pod-id">Generating unique POD ID...</div>
            </div>
            
            <div class="form-group">
                <label>POD Name:</label>
                <input type="text" id="podName" required placeholder="e.g., Genesis Migration - Data Setup">
                <div id="podNameImported" class="imported-data" style="display: none;">
                    <div class="imported-label">üì• Imported from source:</div>
                    <div id="podNameSource"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Planned Start Date:</label>
                <input type="date" id="startDate" required>
                <div id="startDateImported" class="imported-data" style="display: none;">
                    <div class="imported-label">üì• Imported from source:</div>
                    <div id="startDateSource"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Planned End Date:</label>
                <input type="date" id="endDate" required>
                <div id="endDateImported" class="imported-data" style="display: none;">
                    <div class="imported-label">üì• Imported from source:</div>
                    <div id="endDateSource"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>POD Lead:</label>
                <select id="podLead" required>
                    <option value="">Select POD Lead...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Estimated Hours:</label>
                <input type="number" id="estimatedHours" required placeholder="e.g., 160" min="1">
                <div id="estimatedHoursImported" class="imported-data" style="display: none;">
                    <div class="imported-label">üì• Imported from source:</div>
                    <div id="estimatedHoursSource"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Project Scope & Deliverables:</label>
                <textarea id="scope" rows="6" placeholder="Describe the POD scope, deliverables, and success criteria..."></textarea>
                <div id="scopeImported" class="imported-data" style="display: none;">
                    <div class="imported-label">üì• Imported from source:</div>
                    <div id="scopeSource"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="submit">‚úÖ Create POD</button>
                <button type="button" class="btn-secondary" onclick="goBack()">‚Üê Back to CCB</button>
            </div>
        </form>
        
        <div id="message"></div>
    </div>

<script>
let selectedCcbId = null;
let selectedDataSource = 'manual';
let selectedJiraIssue = null;
let importedData = {};

window.onload = async function() {
    selectedCcbId = localStorage.getItem('selectedCcbId');
    
    if (!selectedCcbId) {
        document.getElementById('ccbDetails').innerHTML = '<p class="error">No CCB item selected. Please go back and select a CCB item.</p>';
        return;
    }

    await loadCcbDetails();
    await loadUsers();
    await generatePodIdPreview();
    setupEventHandlers();
    loadSimulatedJiraData(); // Load simulated JIRA data
};

function setupEventHandlers() {
    // Data source selection
    document.querySelectorAll('.source-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.source-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            selectedDataSource = this.dataset.source;
            toggleImportSections();
        });
    });

    // JIRA search
    document.getElementById('jiraSearchInput').addEventListener('input', function() {
        searchJiraIssues(this.value);
    });

    // Excel upload
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('excelFile');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFileUpload(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => {
        handleFileUpload(e.target.files[0]);
    });
}

function toggleImportSections() {
    // Hide all import sections
    document.getElementById('jiraImport').style.display = 'none';
    document.getElementById('excelUpload').style.display = 'none';

    // Show selected section
    switch(selectedDataSource) {
        case 'jira':
            document.getElementById('jiraImport').style.display = 'block';
            break;
        case 'excel':
            document.getElementById('excelUpload').style.display = 'block';
            break;
        case 'workorder':
            alert('Work Order import coming soon! Please use manual entry or JIRA import for now.');
            // Reset to manual
            document.querySelector('[data-source="manual"]').click();
            break;
    }
    
    // Clear previous imports when switching
    if (selectedDataSource !== 'jira') {
        selectedJiraIssue = null;
        hideImportPreview();
    }
}

// Simulated JIRA Data
function loadSimulatedJiraData() {
    window.simulatedJiraIssues = [
        {
            key: 'AML-MEX-001',
            summary: 'Implement AML Customer Screening Module',
            description: 'Develop automated customer screening system for AML compliance in Mexico operations. Must integrate with existing customer database and regulatory reporting systems.',
            project: 'AML-MEX',
            assignee: 'Asif Mohammed',
            storyPoints: 13,
            priority: 'High',
            startDate: '2025-06-25',
            endDate: '2025-07-15',
            acceptanceCriteria: '- Customer data automatically screened against watch lists\n- Real-time alerts for suspicious activities\n- Integration with regulatory reporting\n- 99.9% uptime requirement',
            businessValue: 'Ensures regulatory compliance and reduces manual screening effort by 80%'
        },
        {
            key: 'KYC-PER-002',
            summary: 'Enhanced KYC Document Validation Peru',
            description: 'Upgrade KYC document validation system for Peru compliance requirements. Include OCR capabilities and automated verification workflows.',
            project: 'KYC-PER',
            assignee: 'Kanya',
            storyPoints: 8,
            priority: 'Medium',
            startDate: '2025-06-20',
            endDate: '2025-07-05',
            acceptanceCriteria: '- OCR integration for document scanning\n- Automated validation workflows\n- Peru regulatory compliance\n- API integration with existing systems',
            businessValue: 'Improves KYC processing speed by 60% and ensures Peru regulatory compliance'
        },
        {
            key: 'TRADE-COL-003',
            summary: 'Trade Finance Platform Colombia Launch',
            description: 'Deploy trade finance platform for Colombian market. Includes local payment methods, currency support, and regulatory compliance.',
            project: 'TRADE-COL',
            assignee: 'Srini',
            storyPoints: 21,
            priority: 'Critical',
            startDate: '2025-07-01',
            endDate: '2025-08-15',
            acceptanceCriteria: '- Multi-currency support (COP, USD)\n- Local payment gateway integration\n- Colombian regulatory compliance\n- Real-time transaction processing',
            businessValue: 'Enables trade finance operations in Colombia, projected $2M revenue increase'
        },
        {
            key: 'RISK-BRA-004',
            summary: 'Risk Assessment Dashboard Brazil',
            description: 'Create executive risk assessment dashboard for Brazilian operations with real-time monitoring and predictive analytics.',
            project: 'RISK-BRA',
            assignee: 'Vinod',
            storyPoints: 5,
            priority: 'Medium',
            startDate: '2025-06-30',
            endDate: '2025-07-20',
            acceptanceCriteria: '- Real-time risk metrics display\n- Predictive analytics integration\n- Executive-level reporting\n- Mobile responsive design',
            businessValue: 'Provides executive visibility into risk exposure and improves decision making'
        },
        {
            key: 'AML-MEX-005',
            summary: 'Transaction Monitoring Enhancement',
            description: 'Enhance transaction monitoring system with machine learning algorithms for better fraud detection in Mexico.',
            project: 'AML-MEX',
            assignee: 'Asif Mohammed',
            storyPoints: 15,
            priority: 'High',
            startDate: '2025-07-10',
            endDate: '2025-08-05',
            acceptanceCriteria: '- ML-based fraud detection\n- Real-time transaction analysis\n- False positive reduction\n- Regulatory reporting integration',
            businessValue: 'Reduces false positives by 40% and improves fraud detection accuracy'
        }
    ];
}

function searchJiraIssues(searchTerm) {
    const resultsContainer = document.getElementById('jiraResults');
    
    if (!searchTerm.trim()) {
        resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Enter search terms to find JIRA issues</div>';
        return;
    }

    const filtered = window.simulatedJiraIssues.filter(issue => 
        issue.key.toLowerCase().includes(searchTerm.toLowerCase()) ||
        issue.summary.toLowerCase().includes(searchTerm.toLowerCase()) ||
        issue.project.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (filtered.length === 0) {
        resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">No JIRA issues found</div>';
        return;
    }

    resultsContainer.innerHTML = filtered.map(issue => `
        <div class="jira-item" onclick="selectJiraIssue('${issue.key}')">
            <div class="jira-key">${issue.key}</div>
            <div class="jira-summary">${issue.summary}</div>
            <div class="jira-details">
                Project: ${issue.project} ‚Ä¢ Priority: ${issue.priority} ‚Ä¢ Story Points: ${issue.storyPoints}
            </div>
        </div>
    `).join('');
}

function selectJiraIssue(issueKey) {
    // Remove previous selection
    document.querySelectorAll('.jira-item').forEach(item => item.classList.remove('selected'));
    
    // Add selection to clicked item
    event.target.closest('.jira-item').classList.add('selected');
    
    // Find the issue data
    selectedJiraIssue = window.simulatedJiraIssues.find(issue => issue.key === issueKey);
    
    if (selectedJiraIssue) {
        showImportPreview();
        populateFormFromJira();
    }
}

function showImportPreview() {
    const preview = document.getElementById('importPreview');
    const content = document.getElementById('previewContent');
    
    content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em;">
            <div><strong>JIRA Key:</strong> ${selectedJiraIssue.key}</div>
            <div><strong>Priority:</strong> ${selectedJiraIssue.priority}</div>
            <div><strong>Story Points:</strong> ${selectedJiraIssue.storyPoints}</div>
            <div><strong>Assignee:</strong> ${selectedJiraIssue.assignee}</div>
        </div>
        <div style="margin-top: 10px;">
            <strong>Summary:</strong> ${selectedJiraIssue.summary}
        </div>
        <div style="margin-top: 10px;">
            <strong>Description:</strong> ${selectedJiraIssue.description.substring(0, 100)}...
        </div>
    `;
    
    preview.style.display = 'block';
}

function hideImportPreview() {
    document.getElementById('importPreview').style.display = 'none';
    // Hide all imported data indicators
    document.querySelectorAll('.imported-data').forEach(el => el.style.display = 'none');
}

function populateFormFromJira() {
    if (!selectedJiraIssue) return;

    importedData = {
        source: 'JIRA',
        sourceKey: selectedJiraIssue.key,
        podName: selectedJiraIssue.summary,
        startDate: selectedJiraIssue.startDate,
        endDate: selectedJiraIssue.endDate,
        estimatedHours: selectedJiraIssue.storyPoints * 8, // Convert story points to hours
        scope: selectedJiraIssue.description + '\n\nAcceptance Criteria:\n' + selectedJiraIssue.acceptanceCriteria + '\n\nBusiness Value:\n' + selectedJiraIssue.businessValue
    };

    // Populate form fields
    document.getElementById('podName').value = importedData.podName;
    document.getElementById('startDate').value = importedData.startDate;
    document.getElementById('endDate').value = importedData.endDate;
    document.getElementById('estimatedHours').value = importedData.estimatedHours;
    document.getElementById('scope').value = importedData.scope;

    // Show imported data indicators
    showImportedDataIndicator('podName', `${selectedJiraIssue.key}: ${selectedJiraIssue.summary}`);
    showImportedDataIndicator('startDate', `Sprint Start: ${formatDate(selectedJiraIssue.startDate)}`);
    showImportedDataIndicator('endDate', `Sprint End: ${formatDate(selectedJiraIssue.endDate)}`);
    showImportedDataIndicator('estimatedHours', `${selectedJiraIssue.storyPoints} story points ‚Üí ${importedData.estimatedHours} hours`);
    showImportedDataIndicator('scope', `${selectedJiraIssue.key} description, acceptance criteria, and business value`);

    // Try to auto-assign POD lead based on JIRA assignee
    const podLeadSelect = document.getElementById('podLead');
    for (let option of podLeadSelect.options) {
        if (option.text.toLowerCase().includes(selectedJiraIssue.assignee.toLowerCase())) {
            option.selected = true;
            break;
        }
    }
}

function showImportedDataIndicator(fieldName, sourceInfo) {
    const indicator = document.getElementById(fieldName + 'Imported');
    const sourceDiv = document.getElementById(fieldName + 'Source');
    
    if (indicator && sourceDiv) {
        sourceDiv.textContent = sourceInfo;
        indicator.style.display = 'block';
    }
}

function handleFileUpload(file) {
    if (!file) return;
    
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        alert('Please upload a valid Excel file (.xlsx or .xls)');
        return;
    }

    const preview = document.getElementById('excelPreview');
    preview.innerHTML = `
        <div style="padding: 20px; background: #e8f5e8; border-radius: 8px; margin-top: 15px;">
            <h4>üìä Excel File Uploaded: ${file.name}</h4>
            <p>File size: ${(file.size / 1024).toFixed(1)} KB</p>
            <p style="color: #6c757d; margin-top: 10px;">
                <em>Excel parsing will be implemented in the next phase. For now, please use manual entry or JIRA import.</em>
            </p>
        </div>
    `;
    preview.style.display = 'block';
}

// Rest of your existing functions (loadCcbDetails, loadUsers, etc.)
async function loadCcbDetails() {
    try {
        const response = await fetch(`/api/ccb/${selectedCcbId}`);
        const ccbItem = await response.json();

        document.getElementById('ccbDetails').innerHTML = `
            <p><strong>CCB ID:</strong> ${ccbItem.ccb_id}</p>
            <p><strong>Business Line:</strong> ${ccbItem.business_line}</p>
            <p><strong>Country:</strong> ${ccbItem.country}</p>
            <p><strong>Title:</strong> ${ccbItem.title}</p>
            <p><strong>Description:</strong> ${ccbItem.description}</p>
        `;
    } catch (error) {
        document.getElementById('ccbDetails').innerHTML = '<p class="error">Error loading CCB details</p>';
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        const users = await response.json();

        const select = document.getElementById('podLead');
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} (${user.role})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function generatePodIdPreview() {
    try {
        document.getElementById('podId').textContent = 'Generating unique POD ID...';
        document.getElementById('podId').className = 'pod-id loading';
        
        const response = await fetch(`/api/ccb/${selectedCcbId}`);
        const ccbItem = await response.json();

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        
        console.log('üî¢ Getting next POD number for:', {
            businessLine: ccbItem.business_line,
            country: ccbItem.country,
            year,
            month
        });
        
        const podNumberResponse = await fetch(`/api/pods/next-number?businessLine=${ccbItem.business_line}&country=${ccbItem.country}&year=${year}&month=${month}`);
        const podNumberData = await podNumberResponse.json();
        
        const podNumber = String(podNumberData.nextNumber).padStart(3, '0');
        const podId = `${ccbItem.business_line}-${ccbItem.country}-${year}-${month}-${podNumber}`;

        document.getElementById('podId').textContent = podId;
        document.getElementById('podId').className = 'pod-id';
        
        console.log('‚úÖ Generated POD ID:', podId);
    } catch (error) {
        console.error('Error generating POD ID:', error);
        document.getElementById('podId').textContent = 'Error generating POD ID';
        document.getElementById('podId').className = 'pod-id error';
    }
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function goBack() {
    window.location.href = '/';
}

function configurePod(podId) {
    localStorage.setItem('currentPodId', podId);
    window.location.href = '/configure-pod.html';
}

document.getElementById('podForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const podId = document.getElementById('podId').textContent;
    
    if (podId.includes('Generating') || podId.includes('Error')) {
        alert('Please wait for POD ID generation to complete');
        return;
    }
    
    const data = {
        podId: podId,
        podName: document.getElementById('podName').value,
        ccbId: selectedCcbId,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        podLead: document.getElementById('podLead').value,
        estimatedHours: document.getElementById('estimatedHours').value,
        scope: document.getElementById('scope').value,
        // Add import metadata
        importSource: selectedDataSource,
        importData: selectedDataSource !== 'manual' ? importedData : null,
        jiraReference: selectedJiraIssue ? selectedJiraIssue.key : null
    };

    console.log('üìù Submitting POD creation with import data:', data);

    try {
        const response = await fetch('/api/pods', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            
            // If imported from JIRA, create initial JIRA stories
            if (selectedDataSource === 'jira' && selectedJiraIssue) {
                await createInitialJiraStories(result.pod.pod_id);
            }
            
            document.getElementById('message').innerHTML = `
                <div style="border: 2px solid green; padding: 20px; margin: 20px 0; background: #f0fff0; border-radius: 10px;">
                    <h3>‚úÖ POD Created Successfully!</h3>
                    <p><strong>POD ID:</strong> <span style="color: blue; font-family: monospace;">${result.pod.pod_id}</span></p>
                    <p><strong>POD Name:</strong> ${result.pod.pod_name}</p>
                    <p><strong>Status:</strong> ${result.pod.status}</p>
                    ${selectedDataSource !== 'manual' ? `
                        <p><strong>Import Source:</strong> ${selectedDataSource.toUpperCase()}</p>
                        ${selectedJiraIssue ? `<p><strong>JIRA Reference:</strong> ${selectedJiraIssue.key}</p>` : ''}
                    ` : ''}
                    <button onclick="configurePod('${result.pod.pod_id}')" 
                            style="background: green; color: white; padding: 15px 25px; border: none; cursor: pointer; font-size: 16px; border-radius: 5px; margin-top: 15px;">
                        ‚öôÔ∏è Configure Resources & Create JIRA Stories
                    </button>
                </div>
            `;
            document.getElementById('podForm').reset();
            await generatePodIdPreview();
        } else {
            const errorData = await response.json();
            document.getElementById('message').innerHTML = `<p class="error">‚ùå Error creating POD: ${errorData.error}</p>`;
        }
    } catch (error) {
        console.error('POD creation error:', error);
        document.getElementById('message').innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
    }
});

async function createInitialJiraStories(podId) {
    try {
        console.log('üìù Creating initial JIRA stories for POD:', podId);
        
        // Create demo stories based on the imported JIRA issue
        const response = await fetch('/api/jira/create-bulk-stories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                podId: podId,
                storyCount: 3
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Created initial JIRA stories:', result.stories.length);
        }
    } catch (error) {
        console.error('‚ùå Error creating initial JIRA stories:', error);
    }
}
</script>
</body>
</html>